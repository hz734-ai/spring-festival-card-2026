<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNY Fireworks Greeting</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    #wrap {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: grid;
      place-items: center;
      background: #000;
    }
    /* The card image */
    #card {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* keeps full card visible */
      image-rendering: auto;
      filter: saturate(1.05) contrast(1.02);
      pointer-events: none;
    }
    /* Canvas overlay */
    #fx {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      mix-blend-mode: screen; /* makes glow blend nicely on red backgrounds */
    }
  </style>
</head>
<body>
  <div id="wrap">
    <img id="card" src="final_red_lantern_high_contrast.png" alt="Greeting card" />
    <canvas id="fx"></canvas>
  </div>

<script>
(() => {
  const canvas = document.getElementById('fx');
  const ctx = canvas.getContext('2d', { alpha: true });

  // HiDPI setup
  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resize);
  resize();

  // ---- Style palette: Spring Festival vibe (red/gold + a little warm white) ----
  const PALETTE = [
    { core: [255, 215, 120], halo: [255, 170, 60] },   // gold
    { core: [255, 235, 200], halo: [255, 190, 120] },  // warm white
    { core: [255, 120, 80],  halo: [255, 70, 40] },    // red-orange
    { core: [255, 80, 60],   halo: [255, 40, 30] },    // deep red
    { core: [255, 200, 90],  halo: [255, 140, 50] }    // amber
  ];

  // Utility
  const rand = (a,b) => a + Math.random()*(b-a);
  const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
  const now = () => performance.now();

  // Particles
  const particles = [];
  const rockets = [];
  const fountains = [];
  const sparks = []; // crackle micro-sparks
  let autoMode = true;

  // Physics tuning
  const GRAVITY = 0.10;            // gentle fall
  const AIR_DRAG = 0.985;          // slow fade drift
  const GLOW_FADE = 0.92;

  // Render helpers
  function setGlow(color, blur) {
    ctx.shadowColor = color;
    ctx.shadowBlur = blur;
  }

  function rgba([r,g,b], a) {
    return `rgba(${r|0},${g|0},${b|0},${a})`;
  }

  function pickColor() {
    return PALETTE[(Math.random() * PALETTE.length) | 0];
  }

  // Determine "safe" burst area that sits in the sky above the bottom objects/text
  function skyRect() {
    const w = window.innerWidth, h = window.innerHeight;
    return {
      x0: w * 0.10,
      x1: w * 0.90,
      y0: h * 0.06,
      y1: h * 0.55
    };
  }

  // --- Rocket (launch) ---
  function launchRocket(x = null) {
    const w = window.innerWidth, h = window.innerHeight;
    const s = skyRect();
    const startX = x ?? rand(w*0.2, w*0.8);
    const startY = h * 0.95;
    const targetX = clamp(startX + rand(-w*0.12, w*0.12), s.x0, s.x1);
    const targetY = rand(s.y0, s.y1);

    const col = pickColor();

    rockets.push({
      x: startX,
      y: startY,
      vx: (targetX - startX) / rand(45, 70),
      vy: (targetY - startY) / rand(45, 70),
      targetY,
      life: rand(45, 75),
      col,
      trail: [],
      type: (Math.random() < 0.45) ? "chrysanthemum"
           : (Math.random() < 0.70) ? "peony"
           : (Math.random() < 0.85) ? "willow"
           : "crackle"
    });
  }

  // --- Burst types: traditional-feeling shapes ---
  function burst(x, y, type = "chrysanthemum", col = pickColor()) {
    const baseN =
      type === "willow" ? rand(90, 140) :
      type === "crackle" ? rand(70, 110) :
      rand(80, 130);

    // Big golden center glow (very CNY)
    particles.push({
      x, y, vx: 0, vy: 0,
      r: rand(6, 10),
      a: 0.9,
      col,
      glow: 28,
      life: rand(16, 24),
      kind: "core"
    });

    for (let i=0; i<baseN; i++) {
      const ang = (i / baseN) * Math.PI * 2 + rand(-0.03, 0.03);
      let spd =
        type === "peony" ? rand(2.1, 3.7) :
        type === "willow" ? rand(1.6, 2.7) :
        type === "crackle" ? rand(2.0, 3.3) :
        rand(2.2, 3.8);

      // Chrysanthemum: slightly layered speeds
      if (type === "chrysanthemum") spd *= (Math.random() < 0.35 ? rand(0.55,0.8) : 1);

      const vx = Math.cos(ang) * spd;
      const vy = Math.sin(ang) * spd;

      particles.push({
        x, y,
        vx, vy,
        r: rand(1.2, 2.4),
        a: rand(0.75, 1.0),
        col,
        glow: rand(10, 18),
        life: type === "willow" ? rand(80, 120) : rand(55, 95),
        kind: type,
        // willow trails droop more
        droop: (type === "willow") ? rand(0.06, 0.10) : rand(0.02, 0.06),
        // crackle spawns micro-sparks
        crackle: (type === "crackle" && Math.random() < 0.22),
      });
    }

    // Crackle burst: extra micro pops near the end
    if (type === "crackle") {
      for (let k=0; k<rand(18, 28); k++) {
        sparks.push({
          x: x + rand(-8, 8),
          y: y + rand(-8, 8),
          t0: now() + rand(250, 900), // delayed pop
          col,
          n: (rand(10, 18) | 0)
        });
      }
    }
  }

  // --- Fountain (地面喷花 / “金喷泉”) ---
  function spawnFountain() {
    const w = window.innerWidth, h = window.innerHeight;
    fountains.push({
      x: rand(w*0.18, w*0.82),
      y: h * 0.86,
      col: { core:[255,210,110], halo:[255,150,70] },
      life: rand(220, 320),
      rate: rand(5, 9)
    });
  }

  // --- Crackle-only (like small “爆竹” feel) ---
  function cracklePop() {
    const w = window.innerWidth, h = window.innerHeight;
    const s = skyRect();
    burst(rand(s.x0, s.x1), rand(s.y0, s.y1), "crackle", pickColor());
  }

  // --- Drawing ---
  function drawParticle(p) {
    const c = p.col;
    const core = rgba(c.core, p.a);
    const halo = rgba(c.halo, p.a * 0.75);

    setGlow(halo, p.glow);
    ctx.beginPath();
    ctx.fillStyle = core;
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }

  function drawTrail(points, col) {
    if (points.length < 2) return;
    ctx.save();
    ctx.globalAlpha = 0.7;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = rgba(col.halo, 0.55);
    setGlow(rgba(col.halo, 0.55), 14);
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for (let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
    ctx.stroke();
    ctx.restore();
  }

  function fadeBackground() {
    // A very slight fade creates persistence trails (nice for fireworks)
    ctx.save();
    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = "rgba(0,0,0,0.15)";
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
    ctx.restore();
  }

  // --- Update loop ---
  let last = now();
  function tick() {
    const t = now();
    const dt = Math.min(33, t - last);
    last = t;

    // Clear with slight persistence
    fadeBackground();

    // Auto fireworks rhythm (Spring Festival feeling: frequent, warm, celebratory)
    if (autoMode) {
      if (Math.random() < 0.06) launchRocket();
      if (Math.random() < 0.012) spawnFountain();
      if (Math.random() < 0.015) cracklePop();
    }

    // Rockets update + draw
    for (let i=rockets.length-1; i>=0; i--) {
      const r = rockets[i];
      r.x += r.vx * (dt/16);
      r.y += r.vy * (dt/16);
      r.vy += GRAVITY * 0.22 * (dt/16); // slight arc

      // add trail points
      r.trail.push({x:r.x, y:r.y});
      if (r.trail.length > 14) r.trail.shift();

      drawTrail(r.trail, r.col);

      // rocket head
      setGlow(rgba(r.col.halo, 0.8), 18);
      ctx.fillStyle = rgba(r.col.core, 0.9);
      ctx.beginPath();
      ctx.arc(r.x, r.y, 2.2, 0, Math.PI*2);
      ctx.fill();

      r.life -= (dt/16);
      if (r.life <= 0 || r.y <= r.targetY) {
        // Burst!
        burst(r.x, r.y, r.type, r.col);
        rockets.splice(i,1);
      }
    }

    // Fountains update + emit
    for (let i=fountains.length-1; i>=0; i--) {
      const f = fountains[i];
      f.life -= (dt/16);
      if (f.life <= 0) { fountains.splice(i,1); continue; }

      // emit upward golden sparks
      const emitCount = (f.rate * (dt/16)) | 0;
      for (let k=0;k<emitCount;k++) {
        const ang = rand(-Math.PI*0.78, -Math.PI*0.22);
        const spd = rand(2.0, 5.2);
        particles.push({
          x: f.x + rand(-6,6),
          y: f.y + rand(-2,2),
          vx: Math.cos(ang)*spd,
          vy: Math.sin(ang)*spd,
          r: rand(1.0, 2.0),
          a: rand(0.65, 0.95),
          col: f.col,
          glow: rand(10, 16),
          life: rand(38, 70),
          kind: "fountain",
          droop: rand(0.05, 0.09),
          crackle: (Math.random() < 0.08)
        });
      }

      // base glow
      setGlow("rgba(255,170,70,0.45)", 28);
      ctx.fillStyle = "rgba(255,200,120,0.18)";
      ctx.beginPath();
      ctx.arc(f.x, f.y, 18, 0, Math.PI*2);
      ctx.fill();
    }

    // Delayed micro crackles
    for (let i=sparks.length-1; i>=0; i--) {
      const s = sparks[i];
      if (t >= s.t0) {
        for (let k=0;k<s.n;k++) {
          const ang = rand(0, Math.PI*2);
          const spd = rand(0.6, 2.2);
          particles.push({
            x: s.x,
            y: s.y,
            vx: Math.cos(ang)*spd,
            vy: Math.sin(ang)*spd,
            r: rand(0.8, 1.5),
            a: rand(0.55, 0.9),
            col: s.col,
            glow: rand(8, 14),
            life: rand(18, 36),
            kind: "spark",
            droop: rand(0.02, 0.05),
            crackle: false
          });
        }
        sparks.splice(i,1);
      }
    }

    // Particles update + draw
    for (let i=particles.length-1; i>=0; i--) {
      const p = particles[i];

      // physics
      p.vx *= AIR_DRAG;
      p.vy *= AIR_DRAG;

      // droop / gravity
      p.vy += (GRAVITY + (p.droop || 0)) * (dt/16);

      p.x += p.vx * (dt/16);
      p.y += p.vy * (dt/16);

      // fade
      p.life -= (dt/16);
      p.a *= GLOW_FADE;

      // crackle spawns tiny sparks randomly near end of life (爆裂感)
      if (p.crackle && p.life < 25 && Math.random() < 0.25) {
        particles.push({
          x: p.x + rand(-2,2),
          y: p.y + rand(-2,2),
          vx: rand(-1.3,1.3),
          vy: rand(-1.3,1.3),
          r: rand(0.7, 1.2),
          a: rand(0.45, 0.8),
          col: { core:[255,235,200], halo:[255,170,90] },
          glow: rand(8, 12),
          life: rand(10, 20),
          kind: "micro",
          droop: rand(0.01, 0.03),
          crackle: false
        });
      }

      // draw
      drawParticle(p);

      // remove
      if (p.life <= 0 || p.a < 0.02 ||
          p.x < -50 || p.x > window.innerWidth+50 ||
          p.y < -50 || p.y > window.innerHeight+80) {
        particles.splice(i,1);
      }
    }

    requestAnimationFrame(tick);
  }

  // Initial burst so it looks alive immediately
  for (let i=0;i<3;i++) launchRocket(rand(window.innerWidth*0.25, window.innerWidth*0.75));
  spawnFountain();

  // Controls
  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      const s = skyRect();
      burst(rand(s.x0, s.x1), rand(s.y0, s.y1), "peony", pickColor());
      e.preventDefault();
    }
    if (e.key.toLowerCase() === 'f') spawnFountain();
    if (e.key.toLowerCase() === 'c') cracklePop();
    if (e.key.toLowerCase() === 'r') autoMode = !autoMode;
  });

  // Click to launch a rocket at that x-position
  window.addEventListener('pointerdown', (e) => {
    launchRocket(e.clientX);
  });

  // Start with a clean frame (no black) by clearing once:
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
